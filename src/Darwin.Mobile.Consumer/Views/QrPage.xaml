<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:Darwin.Mobile.Consumer.ViewModels"
    xmlns:res="clr-namespace:Darwin.Mobile.Consumer.Resources"
    x:Class="Darwin.Mobile.Consumer.Views.QrPage"
    x:DataType="vm:QrViewModel"
    Title="{x:Static res:AppResources.QrTitle}">

    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="16">
            <Label Text="{Binding BusinessDisplayName, StringFormat='Business: {0}'}"
                   FontSize="16"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   IsVisible="{Binding BusinessDisplayName, Converter={StaticResource NullCheckConverter}}" />

            <Label Text="{Binding StatusMessage}"
                   FontSize="14"
                   TextColor="Green"
                   HorizontalTextAlignment="Center"
                   IsVisible="{Binding StatusMessage, Converter={StaticResource NullCheckConverter}}" />

            <!-- Render the QR image; fallback to hidden if no token is available -->
            <Image Source="{Binding QrImage}"
                   HeightRequest="200"
                   WidthRequest="200"
                   HorizontalOptions="Center"
                   IsVisible="{Binding QrImage, Converter={StaticResource NullCheckConverter}}" />

            <!-- Optional text representation for debugging -->
            <Label Text="{Binding QrToken}"
                   FontSize="14"
                   HorizontalOptions="Center"
                   Opacity="0.5" />

            <!-- Show expiry countdown -->
            <Label Text="{Binding ExpiresAtUtc, StringFormat='Expires at: {0:HH:mm:ss}'}"
                   FontSize="16"
                   TextColor="{StaticResource Neutral900}"
                   HorizontalOptions="Center" />

            <!-- Refresh buttons for accrual and redemption -->
            <Button Text="{x:Static res:AppResources.RefreshAccrualButton}"
                    Style="{StaticResource PrimaryButtonStyle}"
                    Command="{Binding RefreshAccrualSessionCommand}" />

            <Button Text="{x:Static res:AppResources.RefreshRedemptionButton}"
                    Style="{StaticResource PrimaryButtonStyle}"
                    Command="{Binding RefreshRedemptionSessionCommand}" />

            <Label Text="{Binding ErrorMessage}"
                   TextColor="Red"
                   FontSize="14"
                   IsVisible="{Binding HasError}" />

            <ActivityIndicator IsVisible="{Binding IsBusy}"
                               IsRunning="{Binding IsBusy}"
                               Color="{StaticResource BrandGold500}" />
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
