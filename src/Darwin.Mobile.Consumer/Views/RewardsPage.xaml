<?xml version="1.0" encoding="utf-8"?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:Darwin.Mobile.Consumer.ViewModels"
    xmlns:res="clr-namespace:Darwin.Mobile.Consumer.Resources"
    xmlns:contracts="clr-namespace:Darwin.Contracts.Loyalty;assembly=Darwin.Contracts"
    x:Class="Darwin.Mobile.Consumer.Views.RewardsPage"
    x:DataType="vm:RewardsViewModel"
    Title="{x:Static res:AppResources.RewardsTitle}">

    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="16">

            <!--
              Business-scoped account summary:
              We intentionally keep points scoped to one selected business,
              because loyalty balances are not globally spendable across businesses.
            -->
            <Label Text="{x:Static res:AppResources.AccountSummaryLabel}"
                   Style="{StaticResource TitleLabelStyle}" />

            <!-- Joined businesses list with per-business points for quick overview. -->
            <Label Text="{x:Static res:AppResources.RewardsJoinedBusinessesLabel}"
                   FontAttributes="Bold"
                   IsVisible="{Binding HasAccounts}" />

            <CollectionView ItemsSource="{Binding Accounts}"
                            IsVisible="{Binding HasAccounts}"
                            HeightRequest="160">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="contracts:LoyaltyAccountSummary">
                        <Border Stroke="{StaticResource BrushGray300}"
                                StrokeThickness="1"
                                Padding="10"
                                Margin="2">
                            <VerticalStackLayout Spacing="2">
                                <Label Text="{Binding BusinessName}"
                                       FontAttributes="Bold" />
                                <Label Text="{Binding PointsBalance, StringFormat='{x:Static res:AppResources.PointsBalanceFormat}'}"
                                       FontSize="13"
                                       Opacity="0.8" />
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Explicit selector for active business context used by rewards/history sections. -->
            <Label Text="{x:Static res:AppResources.RewardsBusinessPickerLabel}"
                   IsVisible="{Binding HasAccounts}" />

            <Picker ItemsSource="{Binding Accounts}"
                    SelectedItem="{Binding SelectedAccount}"
                    ItemDisplayBinding="{Binding BusinessName}"
                    IsVisible="{Binding HasAccounts}" />

            <!-- Selected-business balance only (not aggregated). -->
            <Label Text="{Binding PointsBalance, StringFormat='{x:Static res:AppResources.PointsBalanceFormat}'}"
                   FontSize="18" />

            <Label Text="{x:Static res:AppResources.RewardsAvailableRewardsLabel}"
                   FontAttributes="Bold" />

            <CollectionView ItemsSource="{Binding AvailableRewards}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="contracts:LoyaltyRewardSummary">
                        <Border Stroke="{StaticResource BrushPrimary}"
                                StrokeThickness="1"
                                Padding="12"
                                Margin="4">

                            <VerticalStackLayout>
                                <Label Text="{Binding Name}"
                                       FontSize="16"
                                       FontAttributes="Bold" />

                                <Label Text="{Binding RequiredPoints,
                                                      StringFormat='{x:Static res:AppResources.RewardCostFormat}'}"
                                       FontSize="14" />
                            </VerticalStackLayout>

                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Label Text="{x:Static res:AppResources.RewardsHistoryLabel}"
                   FontAttributes="Bold" />

            <Label Text="{x:Static res:AppResources.RewardsNoHistoryMessage}"
                   IsVisible="{Binding HasHistory, Converter={StaticResource InverseBoolConverter}}" />

            <CollectionView ItemsSource="{Binding RewardHistory}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="contracts:PointsTransaction">
                        <Border Stroke="{StaticResource BrushGray300}"
                                StrokeThickness="1"
                                Padding="12"
                                Margin="2">
                            <Grid ColumnDefinitions="Auto,*,Auto"
                                  RowDefinitions="Auto,Auto"
                                  ColumnSpacing="8"
                                  RowSpacing="2">

                                <Label Grid.Column="0"
                                       Grid.Row="0"
                                       Text="{Binding Type}"
                                       FontAttributes="Bold" />

                                <Label Grid.Column="1"
                                       Grid.Row="0"
                                       Text="{Binding Notes}"
                                       LineBreakMode="TailTruncation" />

                                <Label Grid.Column="2"
                                       Grid.Row="0"
                                       Text="{Binding Delta, StringFormat='{0:+#;-#;0}'}"
                                       FontAttributes="Bold" />

                                <Label Grid.Column="0"
                                       Grid.Row="1"
                                       Grid.ColumnSpan="2"
                                       Text="{Binding OccurredAtUtc, StringFormat='{0:yyyy-MM-dd HH:mm}'}"
                                       FontSize="12"
                                       Opacity="0.7" />

                                <Label Grid.Column="2"
                                       Grid.Row="1"
                                       Text="{Binding Reference}"
                                       FontSize="12"
                                       Opacity="0.7"
                                       HorizontalTextAlignment="End" />
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Label Text="{Binding ErrorMessage}"
                   TextColor="Red"
                   FontSize="14"
                   IsVisible="{Binding HasError}" />

            <ActivityIndicator IsVisible="{Binding IsBusy}"
                               IsRunning="{Binding IsBusy}"
                               Color="{StaticResource BrushPrimary}" />

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>