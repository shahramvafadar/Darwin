@model Darwin.Web.Areas.Admin.ViewModels.Identity.UserEditVm
@{
    ViewData["Title"] = "Edit User";
    var addressesSection = ViewBag.AddressesSection as Darwin.Web.Areas.Admin.ViewModels.Identity.UserAddressesSectionVm;
}

<h2>Edit User</h2>

<form asp-area="Admin" asp-controller="Users" asp-action="Edit" method="post" class="row g-3">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="RowVersion" />

    <div class="col-md-6">
        <label asp-for="FirstName" class="form-label"></label>
        <input asp-for="FirstName" class="form-control" />
        <span asp-validation-for="FirstName" class="text-danger"></span>
    </div>

    <div class="col-md-6">
        <label asp-for="LastName" class="form-label"></label>
        <input asp-for="LastName" class="form-control" />
        <span asp-validation-for="LastName" class="text-danger"></span>
    </div>

    <div class="col-md-4">
        <label asp-for="Locale" class="form-label"></label>
        <field-help for="Locale" text="Select UI language/culture"></field-help>
        <setting-select asp-for="Locale" key="SupportedLocalesCsv"></setting-select>
        <span asp-validation-for="Locale" class="text-danger"></span>
    </div>

    <div class="col-md-4">
        <label asp-for="Currency" class="form-label"></label>
        <field-help for="Currency" text="Select default currency"></field-help>
        <setting-select asp-for="Currency" key="SupportedCurrenciesCsv"></setting-select>
        <span asp-validation-for="Currency" class="text-danger"></span>
    </div>

    <div class="col-md-4">
        <label asp-for="Timezone" class="form-label"></label>
        <field-help for="Timezone" text="Select default timezone"></field-help>
        <setting-select asp-for="Timezone" key="SupportedTimezonesCsv"></setting-select>
        <span asp-validation-for="Timezone" class="text-danger"></span>
    </div>

    <div class="col-md-6">
        <label asp-for="PhoneE164" class="form-label"></label>
        <input asp-for="PhoneE164" class="form-control" />
        <span asp-validation-for="PhoneE164" class="text-danger"></span>
    </div>

    <div class="col-md-3">
        <div class="form-check mt-4 pt-2">
            <input asp-for="IsActive" class="form-check-input" />
            <label asp-for="IsActive" class="form-check-label"></label>
        </div>
    </div>

    <div class="col-12">
        <button class="btn btn-primary" type="submit"><i class="fa fa-save"></i> Save</button>
        <a asp-area="Admin" asp-controller="Users" asp-action="Index" class="btn btn-outline-secondary">Back</a>
    </div>
</form>

<hr />

<h3 class="mt-4">Addresses</h3>

<div id="addresses-section">
    @await Html.PartialAsync("~/Areas/Admin/Views/Users/_AddressesSection.cshtml", addressesSection)
</div>

<partial name="~/Areas/Admin/Views/Shared/_ConfirmDeleteModal.cshtml" />

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Refresh addresses section helper
        async function refreshAddresses(userId) {
            const resp = await fetch('@Url.Action("AddressesSection", "Users", new { area = "Admin" })' + `?userId=${userId}`, { method: 'GET' });
            const html = await resp.text();
            document.getElementById('addresses-section').innerHTML = html;
        }

        // Hook delete modal confirm submit to include rowVersion if present in the row's data attributes.
        const confirmModal = document.getElementById('confirmDeleteModal');
        if (confirmModal) {
            confirmModal.addEventListener('show.bs.modal', function (event) {
                const btn = event.relatedTarget;
                if (!btn) return;

                // These data-* come from the row button.
                const action = btn.getAttribute('data-action');
                const id = btn.getAttribute('data-id');
                const name = btn.getAttribute('data-name') || '';
                const rowVersion = btn.getAttribute('data-rowversion') || '';

                // Fill hidden fields in modal form
                const form = confirmModal.querySelector('form');
                form.setAttribute('action', action);
                form.querySelector('input[name="id"]').value = id;
                const rv = form.querySelector('input[name="rowVersion"]');
                if (rv) rv.value = rowVersion;

                const lbl = confirmModal.querySelector('[data-confirm-name]');
                if (lbl) lbl.textContent = name;
            });
        }
    </script>
}
